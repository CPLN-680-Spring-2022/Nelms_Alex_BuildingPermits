
  San Francisco and the larger Bay Area region is becoming unlivable for most of its long-term lower- *and* middle-class residents. Although many American cities have unaffordable housing markets, the Bay Area's primarily due to the lack of building enough housing. It isn’t that cities don’t have enough land, the issue is simply that the cities’ zoning regulations, politicians, and citizens have restricted the ability to receive building permits. The result is the haunting, ambiguous effects of ‘gentrification’.

  This project seeks to locate where housing units are actually being permitted and if those buildings are relieving the lack of housing, cost of living, and gentrification indicators. To understand if the building permits are pushing the Bay Area into a deeper stage of gentrification, the project will follow these steps:

**Step 1. Gather Permits** – Analyze 2000-2019 building permits for the city of San Francisco – focusing on their neighborhood location, amount of housing units, amount of affordable units, and legal status
*(see Section 1 or [my notebook file that compiles the data]())*

**Step 2. Analyze Changes** – Determine which neighborhoods receive the most permits and if those same neighborhoods also have:
*	Housing Market Increases – via Home Prices, Rental Costs, Evictions
*	Changing Demographics – via Race, Income, Age, Employment, Education
*	Historically Adverse Policies – Exclusionary Zoning, Racial Discrimination
*(see Section 2 & 3)*

**Step 3. Compare Gentrification** – Qualitatively & Quantitatively compare permitting, housing, and demographics between neighborhoods

In report's conclusionIt will be difficult to directly link building permits to housing costs, but the report will end by estimating the observed permit metrics’ effects on the crisis as a whole.

```{r import_libraries, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(scipen=999)

library(tidyverse)
library(lubridate)
library(RColorBrewer)
library(patchwork)
library(scales)
library(knitr)
library(kableExtra)
library(ggplot2)
library(caret)

library(tidycensus)
library(sf)
library(sp)
library(tmap)
#library(ggrepel)
library(tigris)
library(stargazer)
library(ggcorrplot)
library(glue)
library(rvest)
library(spatstat)
library(cowplot)
library(gridExtra)
library(ggpubr)
library(broom)
library(rgdal)
library(spdep)
library(grid)
library(viridis)



```

``` {r import_functions, include=FALSE}
# feet conversions
mile = 5280
# sq feet conversions
sqmile = 27878000
acre = 43560

# million
m = 1000000

# strings & formatting functions
str_replace_vector = function(string, replace, replacement='') 
  str_replace_all(string, setNames(rep(replacement, length(replace)), replace))

count_format = function(col) format(col, digits=0, big.mark = ",")
proportion_format = function(col, digits=2) (col*100) %>%
      round(., digits=digits) %>% paste(., '%',sep='')


count_unique = function(raw_vector) print(c(length(raw_vector), length(unique(raw_vector))))

ceiling_n = function(num, by=10) ceiling(num/by) * by
ceiling_10 = function(num) ceiling_n(num, by=10)
ceiling_5 = function(num) ceiling_n(num, by=5)

# one line group_by, summarize, ungroup
mutate_by = function(.data, group, ...) {
  group_by(.data, !!enquo(group)) %>%
    mutate(...) %>%
    ungroup()
  }

# mapping

mapTheme = function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.text.x = element_text(size = 14))
}

plotTheme = function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    
    
    plot.background = element_blank(),
    
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    
    strip.text.x = element_text(size = 14)
  )
}

# turn sf polys to label

sf_to_labels = function(
  sf_focus, label_field
){
  sf.focus.labels = 
    sf_focus %>%
    st_centroid(., of_largest_polygon = TRUE) %>% 
    mutate(
      lon = 
        map_dbl(
          geometry,
          ~st_centroid(.x, 
                       of_largest_polygon = TRUE,
                       quiet = TRUE,)[[1]]),
      lat = 
        map_dbl(
          geometry, 
          ~st_centroid(.x, 
                       of_largest_polygon = TRUE, 
                       quiet = TRUE,)[[2]])
    )
  sf.focus.labels$label = sf.focus.labels[[label_field]]
  return(sf.focus.labels %>% dplyr::select(label, lon, lat))
}

# breaks to labels
get_labels = function(
  cut_breaks, 
  round_digit = 0, bucket_diff=1, first_start_range=0,
  last_end_range=TRUE, input_end_range='', 
  bucket_suffix='', bucket_prefix=''
){
  labels = 
    cut_breaks %>% gsub(",", " to ", .) %>% 
    str_sub(., 2, -2) %>% unique(.)
  
  list_str = function(l, remove=0){
      format(round(as.numeric(l), 
                   digit=round_digit)-remove, 
             big.mark=",")}
  for (i in seq(from=1,to=length(labels))){
    bucket_range = labels[i] %>% str_split(., " to ")
    start_range = 
      paste(
        bucket_prefix, 
        list_str(bucket_range[[1]][1]))
    end_range = 
      paste(
        list_str(bucket_range[[1]][2], remove=bucket_diff), 
        bucket_suffix)
    if (i == 1 & first_start_range != ''){
      start_range = paste(
        bucket_prefix, 
        list_str(first_start_range))}
    if (i == length(labels) & input_end_range!=''){
      end_range=
        paste(
          list_str(input_end_range), 
          bucket_suffix)
      last_end_range=TRUE
      }
    if (i == length(labels) & last_end_range==FALSE){end_range='+'}
    bucket = paste(
        start_range, 
        'to', 
        end_range) %>% str_trim()
    labels[i] = bucket
    }
  return(labels)
  }

# plot text 
geom_text_sf = function(
  sf.focus.labels,
  fontface='bold', color='black', check_overlap = TRUE,
  ...
){
  labels = 
    geom_text(
        data=sf.focus.labels, check_overlap=check_overlap,
        fontface=fontface, color=color,
        aes(x=lon,y=lat, label=label), ...)
  return(labels)}



```


```{r binary_functions, include=FALSE}

round_str = function(str_num, digits=3) str_num %>% 
        as.numeric() %>%
        round(digits) %>% 
        as.character() %>% 
        str_replace(., "^0\\.", ".") %>%
        str_remove(., "0+$")

round_thresh = function(
  field,
  thresh = .001,
  digits = 3,
  int_check = FALSE,
  commas = FALSE
  ){
  
  if(is.null(field)){return('NULL')}
  if(is.na(field)){return('NA')}
  
  thresh_str = 
    paste('<', round_str(thresh, digits=digits), sep=' ')
  
  field_num = field %>% as.numeric()
  
  field_str = 
    ifelse(
      abs(field_num) < thresh,
      thresh_str,
      ifelse(
        (int_check == TRUE & abs(field_num) >= 1),
        field_num %>% round_str(digits=0),
        field_num %>% round_str(digits=digits)
        ))
  
  return(field_str)
}

round_str = function(str_num, digits=3) str_num %>% 
        as.numeric() %>%
        round(digits) %>% 
        as.character() %>% 
        str_replace(., "^0\\.", ".") %>%
        str_remove(., "0+$")

count_format = 
  function(col) format(col, digits=0, big.mark = ",")

round_thresh = function(
  field,
  thresh = .001,
  digits = 3,
  int_check = FALSE
  ){
  
  if(is.null(field)){return('NULL')}
  if(is.na(field)){return('NA')}
  
  thresh_str = 
    paste('<', round_str(thresh, digits=digits), sep=' ')
  
  field_num = field %>% as.numeric()
  
  field_str = 
    ifelse(
      abs(field_num) < thresh,
      thresh_str,
      ifelse(
        (int_check == TRUE & abs(field_num) >= 1),
        field_num %>% round_str(digits=0),
        field_num %>% round_str(digits=digits)
        ))
  
  return(field_str)
}

```
